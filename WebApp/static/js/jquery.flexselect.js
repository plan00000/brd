(function(a){a.flexselect=function(b,c){this.init(b,c)};a.extend(a.flexselect.prototype,{settings:{allowMismatch:false,allowMismatchBlank:true,sortBy:"score",preSelection:true,hideDropdownOnEmptyInput:false,selectedClass:"flexselect_selected",dropdownClass:"flexselect_dropdown",inputIdTransform:function(b){return b+"_flexselect"},inputNameTransform:function(b){return},dropdownIdTransform:function(b){return b+"_flexselect_dropdown"}},select:null,input:null,dropdown:null,dropdownList:null,cache:[],results:[],lastAbbreviation:null,abbreviationBeforeFocus:null,selectedIndex:0,picked:false,allowMouseMove:true,dropdownMouseover:false,init:function(b,c){this.settings=a.extend({},this.settings,c);this.select=a(b);this.preloadCache();this.renderControls();this.wire()},preloadCache:function(){this.cache=this.select.find("option").map(function(){return{name:a.trim(a(this).text()),value:a(this).val(),score:0}})},renderControls:function(){var b=this.settings.preSelection?this.select.find("option:selected"):null;this.input=a("<input type='text' autocomplete='off' />").attr({id:this.settings.inputIdTransform(this.select.attr("id")),name:this.settings.inputNameTransform(this.select.attr("name")),accesskey:this.select.attr("accesskey"),tabindex:this.select.attr("tabindex"),style:this.select.attr("style"),placeholder:this.select.attr("data-placeholder")}).addClass(this.select.attr("class")).val(a.trim(b?b.text():"")).css({visibility:"visible"});this.dropdown=a("<div></div>").attr({id:this.settings.dropdownIdTransform(this.select.attr("id"))}).addClass(this.settings.dropdownClass);this.dropdownList=a("<ul></ul>");this.dropdown.append(this.dropdownList);this.select.after(this.input).hide();a("body").append(this.dropdown)},wire:function(){var c=this;this.input.click(function(){c.lastAbbreviation=null;c.focus()});this.input.mouseup(function(d){d.preventDefault()});this.input.focus(function(){c.abbreviationBeforeFocus=c.input.val();c.input.select();if(!c.picked){c.filterResults()}});this.input.blur(function(){if(!c.dropdownMouseover){c.hide();if(c.settings.allowMismatchBlank&&a.trim(a(this).val())==""){c.setValue("")}if(!c.settings.allowMismatch&&!c.picked){c.reset()}}if(c.settings.hideDropdownOnEmptyInput){c.dropdownList.show()}});this.dropdownList.mouseover(function(d){if(!c.allowMouseMove){c.allowMouseMove=true;return}if(d.target.tagName=="LI"){var e=c.dropdown.find("li");c.markSelected(e.index(a(d.target)))}});this.dropdownList.mouseleave(function(){c.markSelected(-1)});this.dropdownList.mouseup(function(d){c.pickSelected();c.focusAndHide()});this.dropdown.mouseover(function(d){c.dropdownMouseover=true});this.dropdown.mouseleave(function(d){c.dropdownMouseover=false});this.dropdown.mousedown(function(d){d.preventDefault()});this.input.keyup(function(d){switch(d.keyCode){case 13:d.preventDefault();c.pickSelected();c.focusAndHide();break;case 27:d.preventDefault();c.reset();c.focusAndHide();break;default:c.filterResults();break}if(c.settings.hideDropdownOnEmptyInput){if(c.input.val()==""){c.dropdownList.hide()}else{c.dropdownList.show()}}});this.input.keydown(function(d){switch(d.keyCode){case 9:c.pickSelected();c.hide();break;case 33:d.preventDefault();c.markFirst();break;case 34:d.preventDefault();c.markLast();break;case 38:d.preventDefault();c.moveSelected(-1);break;case 40:d.preventDefault();c.moveSelected(1);break;case 13:case 27:d.preventDefault();d.stopPropagation();break}});var b=this.input;this.select.change(function(){b.val(a.trim(a(this).find("option:selected").text()))})},filterResults:function(){var c=this.input.val();if(c==this.lastAbbreviation){return}var b=[];a.each(this.cache,function(){this.score=LiquidMetal.score(this.name,c);if(this.score>0){b.push(this)}});this.results=b;if(this.settings.sortBy=="score"){this.sortResultsByScore()}else{if(this.settings.sortBy=="name"){this.sortResultsByName()}}this.renderDropdown();this.markFirst();this.lastAbbreviation=c;this.picked=false;this.allowMouseMove=false},sortResultsByScore:function(){this.results.sort(function(d,c){return c.score-d.score})},sortResultsByName:function(){this.results.sort(function(d,c){return d.name<c.name?-1:(d.name>c.name?1:0)})},renderDropdown:function(){var d=this.dropdown.outerWidth()-this.dropdown.innerWidth();var c=this.input.offset();this.dropdown.css({width:(this.input.outerWidth()-d)+"px",top:(c.top+this.input.outerHeight())+"px",left:c.left+"px",maxHeight:""});var b="";a.each(this.results,function(){b+="<li>"+this.name+"</li>"});this.dropdownList.html(b);this.adjustMaxHeight();this.dropdown.show()},adjustMaxHeight:function(){var c=a(window).height()+a(window).scrollTop()-this.dropdown.outerHeight();var b=parseInt(this.dropdown.css("top"),10);this.dropdown.css("max-height",b>c?(Math.max(0,c-b+this.dropdown.innerHeight())+"px"):"")},markSelected:function(f){if(f<0||f>=this.results.length){return}var b=this.dropdown.find("li");b.removeClass(this.settings.selectedClass);this.selectedIndex=f;var d=a(b[f]).addClass(this.settings.selectedClass);var c=d.position().top;var e=c+d.outerHeight()-this.dropdown.height();if(e>0){this.allowMouseMove=false;this.dropdown.scrollTop(this.dropdown.scrollTop()+e)}else{if(c<0){this.allowMouseMove=false;this.dropdown.scrollTop(Math.max(0,this.dropdown.scrollTop()+c))}}},pickSelected:function(){var b=this.results[this.selectedIndex];if(b){this.input.val(b.name);this.setValue(b.value);this.picked=true}else{if(this.settings.allowMismatch){this.setValue.val("")}else{this.reset()}}},setValue:function(b){if(this.select.val()===b){return}this.select.val(b).change()},hide:function(){this.dropdown.hide();this.lastAbbreviation=null},moveSelected:function(b){this.markSelected(this.selectedIndex+b)},markFirst:function(){this.markSelected(0)},markLast:function(){this.markSelected(this.results.length-1)},reset:function(){this.input.val(this.abbreviationBeforeFocus)},focus:function(){this.input.focus()},focusAndHide:function(){this.focus();this.hide()}});a.fn.flexselect=function(b){this.each(function(){if(this.tagName=="SELECT"){new a.flexselect(this,b)}});return this}})(jQuery);
